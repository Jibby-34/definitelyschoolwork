<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loading…</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body {
      background: #0a0b0f;
      color: #e8eaf0;
      font-family: 'Inter', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.2rem;
    }
    .spinner {
      width: 52px; height: 52px;
      border: 3px solid #252a3a;
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 0.85s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #status {
      font-size: 0.82rem;
      color: #6b7280;
      max-width: 340px;
      text-align: center;
      line-height: 1.6;
    }
    #status.error { color: #f87171; }

    /* Error card */
    #error-card {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      background: #181b26;
      border: 1px solid #252a3a;
      border-radius: 18px;
      padding: 2rem 2.5rem;
      max-width: 360px;
      text-align: center;
    }
    #error-card .err-icon { font-size: 2.5rem; }
    #error-card h2 { font-size: 1rem; font-weight: 600; color: #e8eaf0; }
    #error-card p  { font-size: 0.82rem; color: #6b7280; line-height: 1.6; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 0.25rem; }
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 9px 20px; border-radius: 10px;
      font-size: 0.85rem; font-weight: 600; cursor: pointer;
      text-decoration: none; border: none;
      transition: filter 0.2s, transform 0.15s;
    }
    .btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
    .btn-primary { background: linear-gradient(135deg, #7c3aed, #06b6d4); color: #fff; }
    .btn-ghost   { background: #181b26; border: 1px solid #252a3a; color: #e8eaf0; }
  </style>
</head>
<body>
  <div class="spinner" id="spinner"></div>
  <p id="status">Proxying content…</p>

  <!-- Shown when all proxy endpoints fail -->
  <div id="error-card">
    <div class="err-icon">⚠️</div>
    <h2>All proxies failed</h2>
    <p>Every proxy endpoint was unreachable or blocked this site.
       You can still open the game directly in a new tab.</p>
    <div class="btn-row">
      <a id="open-direct" href="#" target="_blank" rel="noopener" class="btn btn-primary">Open in New Tab ↗</a>
      <a href="index.html" class="btn btn-ghost">← Back</a>
    </div>
  </div>

  <script>
    // ─── Simple self-proxy ───────────────────────────────────────────────────
    // Uses a public CORS proxy to fetch external pages, strips X-Frame-Options,
    // and rewrites the document so it can be embedded freely.
    // Educational use only.
    // ────────────────────────────────────────────────────────────────────────

    const PROXY_ENDPOINTS = [
      url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
      url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
      url => `https://thingproxy.freeboard.io/fetch/${url}`,
    ];

    const params = new URLSearchParams(location.search);
    const target = params.get('url');

    if (!target) {
      document.getElementById('status').textContent = 'No URL provided.';
      document.getElementById('status').classList.add('error');
      document.getElementById('spinner').style.display = 'none';
    } else {
      proxyLoad(target, 0);
    }

    async function proxyLoad(url, endpointIndex) {
      if (endpointIndex >= PROXY_ENDPOINTS.length) {
        // All proxies exhausted — show a helpful error with an open-in-new-tab button
        showError(url);
        return;
      }

      const proxyUrl = PROXY_ENDPOINTS[endpointIndex](url);

      try {
        const res = await fetch(proxyUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        let html = await res.text();

        // ── Resolve a base URL for relative assets ──
        const parsed  = new URL(url);
        const lastSlash = parsed.pathname.lastIndexOf('/');
        const basePath  = parsed.origin +
          (lastSlash >= 0 ? parsed.pathname.slice(0, lastSlash + 1) : '/');

        // Inject <base> tag only if none already exists
        if (!/< *base\b/i.test(html)) {
          // Try to insert right after <head> opening tag
          if (/< *head[^>]*>/i.test(html)) {
            html = html.replace(
              /(< *head[^>]*>)/i,
              `$1<base href="${basePath}">`
            );
          } else {
            // Prepend before everything else as a last resort
            html = `<base href="${basePath}">` + html;
          }
        }

        // ── Write the proxied HTML into this document ──
        // document.open/write replaces the page in-place, keeping the same
        // origin (proxy.html's origin) so no X-Frame-Options ever applies.
        document.open('text/html', 'replace');
        document.write(html);
        document.close();

      } catch (err) {
        console.warn(`Proxy endpoint ${endpointIndex} failed:`, err);
        // Try the next proxy endpoint
        proxyLoad(url, endpointIndex + 1);
      }
    }

    function showError(url) {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('status').style.display  = 'none';
      const card = document.getElementById('error-card');
      document.getElementById('open-direct').href = url;
      card.style.display = 'flex';
    }
  </script>
</body>
</html>

